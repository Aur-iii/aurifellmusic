<!DOCTYPE html>
<html lang="en" class="theme-aurora">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auri Fell Music — Blog</title>
  <meta name="theme-color" content="#0b0920" />
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/auri-a-color.png" />
  <link rel="stylesheet" href="./assets/site.css" />
</head>

<body>
  <a class="visually-hidden" href="#main">Skip to content</a>

  <!-- HEADER -->
  <header>
    <div class="wrap brand-row">
      <div class="brand">
        <img class="logo" src="./assets/auri-a-color.png" alt="Auri A logo" width="48" height="48" />
        <span class="title">Auri Fell Music</span>
      </div>

      <nav aria-label="Primary" id="site-nav">
        <a class="nav-link" href="indexxx.html">Home</a>
        <a class="nav-link" href="about.html">About</a>
        <a class="nav-link" href="music.html">Music</a>
        <a class="nav-link" href="contact.html">Contact</a>
        <a class="nav-link active" href="blog.html">Blog</a>
      </nav>

      <!-- Header kebab that morphs to hamburger -->
      <button class="hamburger" id="menuBtn" aria-controls="menuCard" aria-expanded="false" aria-label="Open menu">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <g class="dots">
            <circle cx="12" cy="5" r="2"/>
            <circle cx="12" cy="12" r="2"/>
            <circle cx="12" cy="19" r="2"/>
          </g>
          <g class="lines">
            <rect x="3" y="5"  width="18" height="2" rx="1"/>
            <rect x="3" y="11" width="18" height="2" rx="1"/>
            <rect x="3" y="17" width="18" height="2" rx="1"/>
          </g>
        </svg>
      </button>
    </div>
  </header>
  
  <!-- Mobile menu drawer -->
  <div class="menu-card" id="menuCard" role="dialog" aria-modal="true" aria-label="Menu">
    <!-- Centered close button that rides the drawer -->
    <button class="hamburger inside" id="menuBtnIn" aria-label="Close menu">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <g class="dots">
          <circle cx="12" cy="5" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="12" cy="19" r="2"/>
        </g>
        <g class="lines">
          <rect x="3"  y="5"  width="18" height="2" rx="1"/>
          <rect x="3"  y="11" width="18" height="2" rx="1"/>
          <rect x="3"  y="17" width="18" height="2" rx="1"/>
        </g>
      </svg>
    </button>

    <nav class="menu-list" aria-label="Mobile">
      <a class="nav-link" href="indexxx.html">Home</a>
      <a class="nav-link" href="about.html">About</a>
      <a class="nav-link" href="music.html">Music</a>
      <a class="nav-link" href="contact.html">Contact</a>
      <a class="nav-link active" href="blog.html">Blog</a>
    </nav>
  </div>

  <!-- =========================
      FOLLOW DRAWER
      ========================= -->
  <aside class="menu-card follow-card" id="followCard" role="dialog" aria-modal="true" aria-label="Subscribe">
    <header class="follow-header">
      <h3 class="follow-title">Subscribe</h3>
    </header>

    <div class="follow-body">
      <form id="followForm" class="follow-form" novalidate>
        <div class="follow-field">
          <label class="follow-label" for="followEmail">Email</label>
          <input id="followEmail" class="follow-input" type="email" placeholder="Enter your email" required>
        </div>

        <div class="follow-actions">
          <button type="submit" class="follow-btn follow-btn-primary" id="submitFollow">Follow</button>
          <button type="button" class="follow-btn follow-btn-secondary" id="unfollowBtn">Unfollow</button>
          <button type="button" class="follow-btn follow-btn-tertiary" id="followCancel">Cancel</button>
        </div>

        <div class="follow-status" id="followStatus" aria-live="polite"></div>
      </form>
    </div>
  </aside>

<!-- =========================
     CREATE POST DRAWER
     ========================= -->
<aside class="menu-card create-card" id="createCard" role="dialog" aria-modal="true" aria-label="Create post">
  <button class="hamburger inside" id="createClose" aria-label="Close create post">
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <g class="dots"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></g>
      <g class="lines"><rect x="3" y="5" width="18" height="2" rx="1"/><rect x="3" y="11" width="18" height="2" rx="1"/><rect x="3" y="17" width="18" height="2" rx="1"/></g>
    </svg>
  </button>

  <!-- full-width header stays edge-to-edge -->
  <header class="follow-head">
    <h3 class="follow-title">Create a post</h3>
  </header>

  <!-- padded body wrapper -->
  <div class="drawer-body">
    <form id="createForm" class="follow-form" novalidate>
      <!-- Title -->
      <div class="follow-field">
        <label class="follow-label" for="postTitle">Title</label>
        <input id="postTitle" class="follow-input" type="text" placeholder="Post title" required />
      </div>

      <!-- Hero image + side -->
      <div class="follow-field">
        <label class="follow-label">Hero image</label>
        <input id="postHero" class="follow-input" type="file" accept="image/*" />
        <div class="create-row">
          <label class="chip"><input type="radio" name="heroSide" value="left"> Left</label>
          <label class="chip"><input type="radio" name="heroSide" value="right" checked> Right</label>
        </div>
        <div id="heroPreview" class="create-preview"></div>
      </div>

      <!-- Body -->
      <div class="follow-field">
        <label class="follow-label" for="postBody">Body</label>
        <textarea id="postBody" class="follow-input" rows="6" placeholder="Write your post. Blank lines = new paragraphs."></textarea>
      </div>

      <!-- Gallery -->
      <div class="follow-field">
        <label class="follow-label">Gallery</label>
        <input id="postGallery" class="follow-input" type="file" accept="image/*" multiple />
        <div id="galleryPreview" class="create-gallery-list" aria-live="polite"></div>
      </div>

      <!-- Actions -->
      <div class="follow-actions">
        <button type="submit" id="publishPost" class="follow-btn follow-btn-primary">Publish</button>
        <button type="button" id="createCancel" class="follow-btn follow-btn-tertiary">Cancel</button>
      </div>
    </form>
  </div>
</aside>


  <!-- page veil (full-height content well) -->
  <div class="page-veil" aria-hidden="true"></div>
  <!-- slide-out backdrop -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <main class="wrap" id="main">

    <div class="i-div tight"> </div>
  
    <!-- Blog Header -->
    <section class="blog-header">
      <div class="blog-info">
        <img src="./assets/auri-headshot-square.png" alt="Auri Headshot" class="blog-headshot">
        <div class="blog-buttons">
          <!-- kept exactly as-is per your request -->
          <button class="follow-btn" type="button">Follow</button>
          <button class="create-btn hidden" type="button">Create Post</button>
        </div>
      </div>

    <!-- SOCIALS -->
    <section class="socials" aria-label="Social links">
      <a href="https://www.youtube.com/c/AuriLuve" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24"><path fill="currentColor" d="M23 9.71a8.5 8.5 0 0 0-.91-4.13a2.92 2.92 0 0 0-1.72-1A78.36 78.36 0 0 0 12 4.27a78.45 78.45 0 0 0-8.34.3a2.87 2.87 0 0 0-1.46.74c-.9.83-1 2.25-1.1 3.45a48.29 48.29 0 0 0 0 6.48a9.55 9.55 0 0 0 .3 2a3.14 3.14 0 0 0 .71 1.36a2.86 2.86 0 0 0 1.49.78a45.18 45.18 0 0 0 6.5.33c3.5.05 6.57 0 10.2-.28a2.88 2.88 0 0 0 1.53-.78a2.49 2.49 0 0 0 .61-1a10.58 10.58 0 0 0 .52-3.4c.04-.56.04-3.94.04-4.54ZM9.74 14.85V8.66l5.92 3.11c-1.66.92-3.85 1.96-5.92 3.08Z"/></svg>    
      </a>
      <a href="https://www.instagram.com/auri_luve/?hl=en" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
        <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5a3.53 3.53 0 0 1-2.5-1.04a3.54 3.54 0 0 1-1.04-2.5a3.53 3.53 0 0 1 1.04-2.5A3.54 3.54 0 0 1 12 8.42a3.53 3.53 0 0 1 2.5 1.04a3.54 3.54 0 0 1 1.04 2.5a3.53 3.53 0 0 1-1.04 2.5A3.54 3.54 0 0 1 12 15.5"/><path fill="currentColor" fill-rule="evenodd" d="M7.41 1.07C8.343 1.02 9.87.996 12 .996q3.195 0 4.59.074c.825.03 1.64.17 2.43.417c.803.286 1.53.748 2.14 1.35a5.8 5.8 0 0 1 1.35 2.14c.249.797.398 1.62.442 2.46q.05 1.375.049 4.57q0 3.195-.074 4.59a9.3 9.3 0 0 1-.417 2.43a5.8 5.8 0 0 1-1.35 2.14a5.8 5.8 0 0 1-2.14 1.35a9.3 9.3 0 0 1-2.43.417c-.933.05-2.46.074-4.59.074q-3.195 0-4.59-.074a8 8 0 0 1-2.43-.466a5.3 5.3 0 0 1-2.14-1.3a5.6 5.6 0 0 1-1.35-2.14a9.3 9.3 0 0 1-.417-2.43c-.05-.933-.074-2.46-.074-4.59q0-3.195.074-4.59c.03-.825.17-1.64.417-2.43c.286-.803.748-1.53 1.35-2.14s1.33-1.06 2.14-1.35a9.3 9.3 0 0 1 2.43-.417zm9.72 3.89a1.365 1.365 0 0 1 1.732.178c.257.256.403.604.408.968a1.6 1.6 0 0 1-.432.967a1.24 1.24 0 0 1-.943.408a1.32 1.32 0 0 1-.968-.408a1.37 1.37 0 0 1-.302-1.496a1.37 1.37 0 0 1 .507-.617zM9.25 7.24A5.34 5.34 0 0 1 12 6.499c.967-.006 1.92.25 2.75.741a5.5 5.5 0 0 1 2.01 2.01a5.47 5.47 0 0 1 0 5.5a5.5 5.5 0 0 1-2.01 2.01a5.47 5.47 0 0 1-5.5 0a5.5 5.5 0 0 1-2.01-2.01a5.47 5.47 0 0 1 0-5.5a5.53 5.53 0 0 1 2.01-2.01" clip-rule="evenodd"/></svg>
      </a>
      <a href="https://www.tiktok.com/@auri_luve" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 256 256"><path fill="currentColor" d="M232 80v40a8 8 0 0 1-8 8a103.25 103.25 0 0 1-48-11.71V156a76 76 0 0 1-152 0c0-36.9 26.91-69.52 62.6-75.88A8 8 0 0 1 96 88v42.69a8 8 0 0 1-4.57 7.23A20 20 0 1 0 120 156V24a8 8 0 0 1 8-8h40a8 8 0 0 1 8 8a48.05 48.05 0 0 0 48 48a8 8 0 0 1 8 8Z"/></svg>
      </a>
      <a href="https://www.facebook.com/auriluve/" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 464 488"><path fill="currentColor" d="M462 78q0-30-23-53T386 2H78Q48 2 25 25T2 78v308q0 30 23 53t53 23h154V288h-56v-76h56v-30q0-39 25.5-68.5T318 84h62v76h-62q-5 0-9.5 6t-4.5 15v31h76v76h-76v174h82q30 0 53-23t23-53V78z"/></svg>
      </a>
      <a href="https://discord.gg/yuPxHuxY4F" target="_blank" rel="noopener noreferrer" aria-label="Discord">
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 16 16"><path fill="currentColor" d="M13.553 3.016A13.233 13.233 0 0 0 10.253 2a9.068 9.068 0 0 0-.423.86a12.293 12.293 0 0 0-3.664 0A9.112 9.112 0 0 0 5.744 2A13.358 13.358 0 0 0 2.44 3.018C.351 6.108-.215 9.123.068 12.094a13.306 13.306 0 0 0 4.048 2.033a9.78 9.78 0 0 0 .867-1.399a8.605 8.605 0 0 1-1.365-.652c.115-.083.227-.168.335-.251a9.51 9.51 0 0 0 8.094 0c.11.09.222.175.335.251a8.648 8.648 0 0 1-1.368.654a9.7 9.7 0 0 0 .867 1.396a13.248 13.248 0 0 0 4.051-2.03c.332-3.446-.568-6.433-2.379-9.08Zm-8.21 7.25c-.79 0-1.442-.715-1.442-1.596c0-.881.63-1.603 1.439-1.603s1.456.722 1.442 1.603c-.014.88-.636 1.597-1.44 1.597Zm5.315 0c-.79 0-1.44-.715-1.44-1.596c0-.881.63-1.603 1.44-1.603c.81 0 1.452.722 1.438 1.603c-.014.88-.634 1.597-1.438 1.597Z"/></svg>
      </a>
    </section>

    <div class="soft-div"></div>

    <!-- BLOG POSTS -->
    <section class="blog-posts">
      <article class="blog-post right">
        <img class="post-image" src="./assets/auri-headshot-square.png" alt="">
        <div class="post-content">
          <p class="post-date">Oct 15, 2025</p>
          <h3 class="post-title">First Post</h3>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
            Vivamus at dui nec nisl gravida dapibus. yada yada yada 
            yada yada yada yada yada yada yada yada yada yada yada 
            yada yada yada yada yada yada yada yada yada yada yada 
            yada yada yada yada yada yada yada yada yada yada yada 
            yada yada yada yada yada yada yada yada yada yada yada 
            yada yada yada yada yada yada yada yada yada yada yada yada yada </p>

          <div class="post-gallery collage">
            <div class="thumb"><img src="./assets/auri-a-color_light.png" alt="A in light scheme" data-caption="Logo A in the lighter palette"></div>
            <div class="thumb"><img src="./assets/auri-a-color.png"></div>
            <div class="thumb"><img src="./assets/auri-anagram-color_light.png"></div>
            <div class="thumb"><img src="./assets/auri-anagram-color.png"></div>
            <div class="thumb"><img src="./assets/auri-headshot-square.png"></div>
            <div class="thumb"><img src="./assets/beheader.png"></div>
          </div>
        </div>
      </article>
    </section>

    <!-- Buttons -->
    <div class="blog-controls">
      <button class="show-more">Show More</button>
      <button class="show-less">Show Less</button>
    </div>
  </main>

  <footer class="floating">
    <p class="credits">© <span id="y"></span> Auri Fell • <a href="mailto:auri@aurifellmusic.com">auri@aurifellmusic.com</a></p>
  </footer>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    // Initialize EmailJS
    emailjs.init("MLLlLku8J8USwTVeg");
  })();
</script>

<script>
/* =========================
   BLOG — consolidated script
   ========================= */

/* ---------- GLOBAL SETUP ---------- */
document.getElementById('y').textContent = new Date().getFullYear();
const backdrop = document.getElementById('backdrop');

/* ---------- ELEMENTS ---------- */
// Nav
const btnOut   = document.getElementById('menuBtn');
const btnIn    = document.getElementById('menuBtnIn');
const menuCard = document.getElementById('menuCard');

// Follow drawer
const followBtn    = document.querySelector('.blog-header .follow-btn');
const followCard   = document.getElementById('followCard');
const followClose  = document.getElementById('followClose');   // may be null (ok)
const followCancel = document.getElementById('followCancel');
const followForm   = document.getElementById('followForm');
const followEmail  = document.getElementById('followEmail');
const followStatus = document.getElementById('followStatus');
const submitFollow = document.getElementById('submitFollow');
const unfollowBtn  = document.getElementById('unfollowBtn');

// Create drawer
const createBtn      = document.querySelector('.blog-header .create-btn');
const createCard     = document.getElementById('createCard');
const createClose    = document.getElementById('createClose');
const createCancel   = document.getElementById('createCancel');
const createForm     = document.getElementById('createForm');
const postTitle      = document.getElementById('postTitle');
const postHero       = document.getElementById('postHero');
const heroPreview    = document.getElementById('heroPreview');
const postBody       = document.getElementById('postBody');
const postGallery    = document.getElementById('postGallery');
const galleryPreview = document.getElementById('galleryPreview');
const publishPost    = document.getElementById('publishPost');

// Posts + controls
const postsHost   = document.querySelector('.blog-posts');
const showMoreBtn = document.querySelector('.show-more');
const showLessBtn = document.querySelector('.show-less');

/* ---------- STATE ---------- */
let galleryFiles = [];      // FileList is read-only, so we mirror it here

// Show more/less state (STEP logic)
const STEP = 3;
let visible = 0;
let lastDelta = STEP;

const EJS_SERVICE  = "service_aurifellmusic";
const EJS_TEMPLATE = "send_to_follower";
const SITE_NAME    = "Auri Fell — Blog";

function setFollowStatus(msg, ok = true) {
  if (!followStatus) return;
  followStatus.textContent = msg;
  followStatus.classList.remove('status--error','status--success','is-visible');
  followStatus.classList.add(ok ? 'status--success' : 'status--error', 'is-visible');
}
async function sendThanksEmail(toEmail) {
  if (typeof emailjs === 'undefined') throw new Error('EmailJS not loaded');
  return emailjs.send(EJS_SERVICE, EJS_TEMPLATE, {
    to_email: toEmail,
    site_name: SITE_NAME
  });
}
followForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = (followEmail?.value || "").trim().toLowerCase();
  if (!email) return;

  if (submitFollow) {
    submitFollow.disabled = true;
    submitFollow.textContent = "Sending…";
  }
  setFollowStatus("", true);

  try {
    await sendThanksEmail(email);
    setFollowStatus("Thanks! Check your inbox ✉️", true);
    if (submitFollow) submitFollow.textContent = "Sent ✓";
    setTimeout(() => openDrawer(null), 1200);
  } catch (err) {
    console.error(err);
    setFollowStatus("Could not send email. Try again?", false);
    if (submitFollow) submitFollow.textContent = "Follow";
  } finally {
    if (submitFollow) submitFollow.disabled = false;
  }
});
unfollowBtn?.addEventListener('click', () => {
  setFollowStatus("Unfollowed (local only)", false);
  if (submitFollow) submitFollow.textContent = "Follow";
  setTimeout(() => openDrawer(null), 1000);
});

/* ---------- DRAWER CORE ---------- */
function openDrawer(which) {
  const wasFollowOpen = followCard?.classList.contains('open');
  const wasCreateOpen = createCard?.classList.contains('open');

  const openMenu   = which === 'menu';
  const openFollow = which === 'follow';
  const openCreate = which === 'create';
  const anyOpen    = !!which;

  menuCard?.classList.toggle('open', openMenu);
  followCard?.classList.toggle('open', openFollow);
  createCard?.classList.toggle('open', openCreate);
  document.body.classList.toggle('menu-open', anyOpen);
  backdrop?.classList.toggle('show', anyOpen);

  // Reset drawers we just closed or switched away from
  if (!anyOpen && (wasFollowOpen || wasCreateOpen)) {
    if (wasFollowOpen) resetFollowDrawer();
    if (wasCreateOpen) resetCreateDrawer();
  }
  if (openMenu && wasFollowOpen)  resetFollowDrawer();
  if (openMenu && wasCreateOpen)  resetCreateDrawer();
  if (openFollow && wasCreateOpen) resetCreateDrawer();
  if (openCreate && wasFollowOpen) resetFollowDrawer();

  // Focus first control in the opened drawer
  if (anyOpen) {
    setTimeout(() => {
      const host = openMenu ? menuCard : (openFollow ? followCard : createCard);
      const first = host?.querySelector('input,button,a,select,textarea,[tabindex]:not([tabindex="-1"])');
      first?.focus();
    }, 220);
  }
}
function resetFollowDrawer(){
  if (followEmail) followEmail.value = "";
  if (followStatus){
    followStatus.textContent = "";
    followStatus.classList.remove("status--success","status--error","is-visible");
  }
  if (submitFollow){
    submitFollow.disabled = false;
    submitFollow.textContent = "Follow";
  }
}
function resetCreateDrawer(){
  if (createForm) createForm.reset();
  if (heroPreview) heroPreview.innerHTML = '';
  galleryFiles = [];
  if (galleryPreview) galleryPreview.innerHTML = '';
}

/* ---------- TRIGGERS (open/close) ---------- */
// Nav
btnOut?.addEventListener('click', () => {
  const isOpen = menuCard?.classList.contains('open');
  openDrawer(isOpen ? null : 'menu');
});
btnIn?.addEventListener('click', () => openDrawer(null));

// Follow
followBtn?.addEventListener('click', () => {
  const isOpen = followCard?.classList.contains('open');
  openDrawer(isOpen ? null : 'follow');
});
followClose?.addEventListener?.('click', () => openDrawer(null));
followCancel?.addEventListener('click', () => openDrawer(null));

// Create
createBtn?.addEventListener('click', () => {
  const isOpen = createCard?.classList.contains('open');
  openDrawer(isOpen ? null : 'create');
});
createClose?.addEventListener('click', () => openDrawer(null));
createCancel?.addEventListener('click', () => openDrawer(null));

/* ---------- OUTSIDE-CLICK + ESC ---------- */
document.addEventListener('keydown', e => { if (e.key === 'Escape') openDrawer(null); });
backdrop?.addEventListener('click', () => openDrawer(null));
// whitelist all drawers + their buttons
document.addEventListener('click', e => {
  const inside = e.target.closest('#menuCard, #menuBtn, #menuBtnIn, #followCard, .blog-header .follow-btn, #createCard, .blog-header .create-btn');
  if (!inside) openDrawer(null);
});

/* ---------- CREATE: previews ---------- */
// Hero preview (single)
postHero?.addEventListener('change', () => {
  heroPreview.innerHTML = '';
  const file = postHero.files?.[0];
  if (!file) return;
  const img = document.createElement('img');
  img.alt = 'Hero preview';
  img.src = URL.createObjectURL(file);
  heroPreview.appendChild(img);
});
// Gallery preview chips (add/remove)
postGallery?.addEventListener('change', () => {
  galleryFiles = [...postGallery.files];
  renderGalleryChips();
});
function renderGalleryChips(){
  galleryPreview.innerHTML = '';
  galleryFiles.forEach((file, idx) => {
    const chip = document.createElement('div');
    chip.className = 'file-chip';
    chip.textContent = file.name;
    const rm = document.createElement('button');
    rm.type = 'button';
    rm.textContent = 'Remove';
    rm.addEventListener('click', () => {
      galleryFiles.splice(idx, 1);
      renderGalleryChips();
    });
    chip.appendChild(rm);
    galleryPreview.appendChild(chip);
  });
}

/* ---------- CREATE: helpers ---------- */
function formatDate(d=new Date()){
  return d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
}
function sideChoice(){
  const el = createForm?.querySelector('input[name="heroSide"]:checked');
  return (el?.value === 'left') ? 'left' : 'right';
}
// Split body by blank lines -> <p>…</p>
function bodyToParagraphs(text){
  return text
    .split(/\n\s*\n/g)
    .map(s => s.trim())
    .filter(Boolean)
    .map(p => `<p>${escapeHTML(p)}</p>`)
    .join('\n');
}
function escapeHTML(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
// Build collage wrapper with up to 4 thumbs (rest -> +N)
async function buildCollage(gFiles){
  if (!gFiles.length) return '';
  const urls = await Promise.all(gFiles.map(f => URL.createObjectURL(f)));
  const thumbs = urls.slice(0,4).map(u => `<div class="thumb"><img src="${u}" alt=""></div>`).join('');
  return `<div class="post-gallery collage">${thumbs}</div>`;
}

/* ---------- CREATE: submit ---------- */
createForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = (postTitle?.value || '').trim();
  const body  = (postBody?.value  || '').trim();
  if (!title) { postTitle?.focus(); return; }

  const heroFile = postHero.files?.[0] || null;
  const heroURL  = heroFile ? URL.createObjectURL(heroFile) : '';
  const side     = sideChoice(); // 'left' or 'right'
  const galleryHTML = await buildCollage(galleryFiles);

  const article = document.createElement('article');
  article.className = `blog-post ${side}`;
  article.innerHTML = `
    ${heroURL ? `<img class="post-image" src="${heroURL}" alt="">` : ''}
    <div class="post-content">
      <p class="post-date">${formatDate()}</p>
      <h3 class="post-title">${escapeHTML(title)}</h3>
      ${body ? bodyToParagraphs(body) : ''}
      ${galleryHTML}
    </div>
  `;
  // Prepend new post
  postsHost?.insertBefore(article, postsHost.firstChild);
  // Init collage dataset + lightbox for the new post
  try { normalizePostGalleries(article); } catch {}
  // Close + reset form/drawer
  openDrawer(null);
  // Keep Show more/less sane if you're using it
  try { recomputeShowButtons(); } catch {}
});

/* ---------- SHOW MORE / SHOW LESS ---------- */
function applyVisibility(){
  const items = postsHost?.querySelectorAll('.blog-post') || [];
  items.forEach((post, idx) => {
    post.style.display = (idx < visible) ? '' : 'none';
  });
}
function updateButtons(){
  const total = postsHost?.querySelectorAll('.blog-post').length || 0;
  if (total === 0 || total <= STEP) {
    showMoreBtn?.classList.add('hidden');
    showLessBtn?.classList.add('hidden');
  } else {
    showMoreBtn?.classList.toggle('hidden', visible >= total);
    showLessBtn?.classList.toggle('hidden', visible <= STEP);
  }
}
function recomputeShowButtons(){
  const total = postsHost?.querySelectorAll('.blog-post').length || 0;
  visible = Math.min(total, Math.max(visible || STEP, STEP));
  applyVisibility();
  updateButtons();
}
// Init + wire buttons
document.addEventListener('DOMContentLoaded', () => {
  const total = postsHost?.querySelectorAll('.blog-post').length || 0;
  visible = Math.min(total, STEP);
  lastDelta = STEP;
  applyVisibility();
  updateButtons();
});
showMoreBtn?.addEventListener('click', () => {
  const total = postsHost?.querySelectorAll('.blog-post').length || 0;
  const remaining = total - visible;
  const delta = Math.min(STEP, remaining);
  visible += delta;
  lastDelta = delta;
  applyVisibility();
  updateButtons();
});
showLessBtn?.addEventListener('click', () => {
  visible = Math.max(STEP, visible - lastDelta);
  lastDelta = STEP; // subsequent collapses go by STEP unless a new expand happens
  applyVisibility();
  updateButtons();
});

/* ---------- LOCAL SERVER DETECTION (keeps Create button clickable on file://) ---------- */
// In file:// mode: show Create button and skip pings.
// When served over http(s): start hidden; reveal after /health ok (expects text "ok:<token>")
(function(){
  var CREATE_BTN = document.querySelector('.create-btn');
  var HEALTH_URL = 'http://localhost:5173/health';
  var CREATE_URL = 'http://localhost:5173/create-post';
  var RECHECK_MS = 20000;
  var _csrf = null;
  var IS_FILE = (location.protocol === 'file:');

  if (!IS_FILE && CREATE_BTN) CREATE_BTN.classList.add('hidden');

  function ping(){
    return fetch(HEALTH_URL, {
      method: 'GET',
      mode: 'cors',
      cache: 'no-store',
      headers: { 'Accept': 'text/plain' }
    })
    .then(function(res){
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.text();
    })
    .then(function(text){
      var parts = (text || '').split(':');
      if (parts[0] !== 'ok' || !parts[1]) throw new Error('bad payload');
      _csrf = parts[1];
      CREATE_BTN && CREATE_BTN.classList.remove('hidden');
      return true;
    })
    .catch(function(){
      _csrf = null;
      CREATE_BTN && CREATE_BTN.classList.add('hidden');
      return false;
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    if (IS_FILE) {
      _csrf = null;
      CREATE_BTN && CREATE_BTN.classList.remove('hidden');
    } else {
      ping();
      setInterval(ping, RECHECK_MS);
    }
  });

  // When you wire real POSTs, you'll use _csrf and CREATE_URL.
  // For now we just open the drawer; publish happens entirely client-side.
  CREATE_BTN && CREATE_BTN.addEventListener('click', function(){
    openDrawer('create');
  });
})();

/* ---------- GALLERY (unchanged core) ---------- */
function normalizePostGalleries(root = document){
  (root.querySelectorAll?.('.post-gallery') || []).forEach(gallery => {
    const thumbs = Array.from(gallery.querySelectorAll('.thumb'));
    const imgs   = thumbs.map(t => t.querySelector('img')).filter(Boolean);
    if (!imgs.length) { gallery.classList.add('hidden'); return; }

    const allItems = imgs.map(img => {
      const src = img.currentSrc || img.src;
      const alt = img.alt || 'Gallery image';
      const caption = img.dataset.caption?.trim() || img.alt || '';
      return { src, alt, caption };
    });
    gallery.dataset.images = JSON.stringify(allItems);
    gallery.classList.add('collage');

    if (imgs.length <= 4) {
      thumbs.slice(imgs.length).forEach(t => t.remove());
      if (thumbs[3]) {
        thumbs[3].classList.remove('more');
        thumbs[3].removeAttribute('data-more');
        thumbs[3].querySelector('.more-badge')?.remove();
      }
    } else {
      let fourth = thumbs[3];
      if (!fourth) {
        fourth = document.createElement('div');
        fourth.className = 'thumb';
        fourth.appendChild(imgs[3].cloneNode(true));
        gallery.appendChild(fourth);
      }
      const extraCount = imgs.length - 4;
      fourth.classList.add('more');
      fourth.setAttribute('data-more', `+${extraCount}`);
      let badge = fourth.querySelector('.more-badge');
      if (!badge) {
        badge = document.createElement('div');
        badge.className = 'more-badge';
        fourth.appendChild(badge);
      }
      badge.textContent = `+${extraCount}`;
      const fourthImg = fourth.querySelector('img');
      if (fourthImg && imgs[3]) {
        fourthImg.src = imgs[3].src;
        fourthImg.alt = imgs[3].alt || 'Gallery image';
      }
      Array.from(gallery.querySelectorAll('.thumb')).slice(4).forEach(t => t.remove());
    }

    gallery.onclick = () => openGalleryLightbox(gallery, 0);
  });
}

/* ---------- LIGHTBOX (unchanged) ---------- */
let lb,lbImg,lbBlurb,lbCounter,lbPrev,lbNext,lbClose,lbList=[],lbIndex=0;
function ensureLightbox(){
  if (lb) return;
  lb = document.createElement('div');
  lb.className = 'gallery-modal';
  lb.innerHTML = `
    <div class="gallery-modal__overlay"></div>
    <div class="gallery-modal__frame" role="dialog" aria-modal="true" aria-label="Image gallery">
      <button class="gallery-modal__close" aria-label="Close">✕</button>
      <button class="gallery-modal__arrow prev" aria-label="Previous">‹</button>
      <div class="gallery-modal__image-wrap">
        <img class="gallery-modal__img" alt="">
        <div class="gallery-modal__blurb"></div>
        <div class="gallery-modal__counter"></div>
      </div>
      <button class="gallery-modal__arrow next" aria-label="Next">›</button>
    </div>`;
  document.body.appendChild(lb);
  lbImg     = lb.querySelector('.gallery-modal__img');
  lbCounter = lb.querySelector('.gallery-modal__counter');
  lbBlurb   = lb.querySelector('.gallery-modal__blurb');
  lbPrev    = lb.querySelector('.gallery-modal__arrow.prev');
  lbNext    = lb.querySelector('.gallery-modal__arrow.next');
  lbClose   = lb.querySelector('.gallery-modal__close');
  lb.querySelector('.gallery-modal__overlay').addEventListener('click', closeGalleryLightbox);
  lbClose.addEventListener('click', closeGalleryLightbox);
  lbPrev.addEventListener('click', () => navGallery(-1));
  lbNext.addEventListener('click', () => navGallery(1));
  document.addEventListener('keydown', (e)=>{
    if (!lb.classList.contains('is-open')) return;
    if (e.key === 'Escape')     closeGalleryLightbox();
    if (e.key === 'ArrowLeft')  navGallery(-1);
    if (e.key === 'ArrowRight') navGallery(1);
  });
}
function openGalleryLightbox(gallery,start=0){
  ensureLightbox();
  try{lbList=JSON.parse(gallery.dataset.images||'[]');}catch{lbList=[];}
  if(!lbList.length)return;
  lbIndex=Math.max(0,Math.min(start,lbList.length-1));
  renderGalleryImage();
  lb.classList.add('is-open');
}
function closeGalleryLightbox(){lb?.classList.remove('is-open');}
function navGallery(d){ if(!lbList.length)return; lbIndex=(lbIndex+d+lbList.length)%lbList.length; renderGalleryImage(); }
function renderGalleryImage(){
  const item = lbList[lbIndex];
  if (!item) return;
  lbImg.src = item.src;
  lbImg.alt = item.alt || 'Gallery image';
  const text = (item.caption || item.alt || '').trim();
  lbBlurb.textContent = text;
  lbBlurb.style.display = text ? '' : 'none';
  lbCounter.textContent = `${lbIndex + 1} / ${lbList.length}`;
}

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  normalizePostGalleries();
});
</script>



</body>
</html>
